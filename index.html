<!DOCTYPE html>
<html>
<head>
  <title>Dhruv Meet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <!-- Styles -->
  <style>
    body { margin:0; font-family: 'Roboto', sans-serif; display:flex; height:100vh; }
    #videoSection { width:60%; background:black; display:flex; flex-direction:column; justify-content:center; align-items:center; }
    video { width:90%; height:auto; margin:10px; border-radius:10px; background:black; }
    #chatSection { width:40%; display:flex; flex-direction:column; background:#f1f1f1; padding:10px; box-sizing:border-box; }
    #messages { flex:1; overflow-y:auto; background:#fff; padding:10px; border-radius:5px; margin-bottom:5px; }
    input { padding:10px; margin:5px 0; border:1px solid #ccc; border-radius:5px; width:100%; box-sizing:border-box; }
    button { background:#4CAF50; color:white; border:none; padding:10px; border-radius:5px; cursor:pointer; margin:5px 0; }
    button:hover { background:#45a049; }
    h2 { text-align:center; }
  </style>
</head>
<body>

<div id="videoSection">
  <h2>Dhruv Meet Video</h2>
  <video id="localVideo" autoplay playsinline muted></video>
  <video id="remoteVideo" autoplay playsinline></video>
</div>

<div id="chatSection">
  <input id="roomInput" placeholder="Enter Room Code">
  <button onclick="joinRoom()">Join Room</button>
  <div id="messages"></div>
  <input id="messageInput" placeholder="Type message">
  <button onclick="sendMessage()">Send</button>
</div>

<script>
  // ---------- Firebase Config ----------
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "dhruv-meet.firebaseapp.com",
    projectId: "dhruv-meet",
    storageBucket: "dhruv-meet.firebasestorage.app",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID",
    measurementId: "YOUR_MEASUREMENT_ID"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ---------- WebRTC & Firestore Setup ----------
  let roomId;
  let localStream;
  let peerConnection;
  const servers = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

  async function joinRoom() {
    roomId = document.getElementById("roomInput").value;
    if (!roomId) return alert("Enter a room code");

    localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
    document.getElementById("localVideo").srcObject = localStream;

    peerConnection = new RTCPeerConnection(servers);
    localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

    peerConnection.ontrack = event => {
      document.getElementById("remoteVideo").srcObject = event.streams[0];
    };

    peerConnection.onicecandidate = event => {
      if (event.candidate) db.collection("rooms").doc(roomId).collection("candidates").add(event.candidate.toJSON());
    };

    const roomRef = db.collection("rooms").doc(roomId);
    const doc = await roomRef.get();

    if (!doc.exists) {
      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);
      await roomRef.set({ offer: JSON.stringify(offer) });

      roomRef.collection("answers").onSnapshot(snapshot => {
        snapshot.docChanges().forEach(change => {
          if (change.type === "added") {
            peerConnection.setRemoteDescription(JSON.parse(change.doc.data().answer));
          }
        });
      });
    } else {
      const data = doc.data();
      await peerConnection.setRemoteDescription(JSON.parse(data.offer));
      const answer = await peerConnection.createAnswer();
      await peerConnection.setLocalDescription(answer);
      roomRef.collection("answers").add({ answer: JSON.stringify(answer) });
    }

    roomRef.collection("candidates").onSnapshot(snapshot => {
      snapshot.docChanges().forEach(change => {
        if (change.type === "added") {
          peerConnection.addIceCandidate(new RTCIceCandidate(change.doc.data()));
        }
      });
    });

    roomRef.collection("messages").onSnapshot(snapshot => {
      snapshot.docChanges().forEach(change => {
        if (change.type === "added") {
          const div = document.createElement("div");
          div.innerText = change.doc.data().text;
          document.getElementById("messages").appendChild(div);
          div.scrollIntoView({ behavior: "smooth" });
        }
      });
    });
  }

  // ---------- Send Chat Message ----------
  function sendMessage() {
    const msg = document.getElementById("messageInput").value;
    if (!msg) return;
    db.collection("rooms").doc(roomId).collection("messages").add({ text: msg });
    document.getElementById("messageInput").value = "";
  }
</script>

</body>
</html>
